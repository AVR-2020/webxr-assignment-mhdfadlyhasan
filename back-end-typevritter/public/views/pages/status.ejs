<!doctype html>
<html>
  <%- include('../layout/header'); -%>
  <script>
    var setint  = '';
    AFRAME.registerComponent('tong-sampah', {
      init: function () {
        this.el.addEventListener('collide', function (evt) {
          var id_status = evt.detail.body.el.getAttribute('id_status')
          $('#'+evt.detail.body.el.getAttribute('id_status')+'-statuscontent').remove();
          axios.post('/del_status', {
            id_status: id_status
          })
          .then(object => {
            if(object.data == 'success') {
              console.log('Deleted')
            }
          })
        });
      }
    });
    AFRAME.registerComponent('kotak-status', {
      init: function () {
        console.log('init status box')
        var self =  this.el
          this.el.addEventListener('mousedown',function(e) {
            var player = document.getElementById("camera")
            var self = this
            clearInterval(setint);
            e.target.removeAttribute('dynamic-body')
            setint = setInterval(function () {
                var positon = player.getAttribute('position')
                $('#'+self.id).attr("position", `${positon.x} ${positon.y} ${positon.z-0.2}`);
            },50);
          });
          
          this.el.addEventListener('mouseup',function(e) {
            clearInterval(setint);
            var atribute = document.createAttribute("dynamic-body")
            e.target.setAttributeNode(atribute)
          });
      }
    });
    AFRAME.registerComponent('send-status-button', {
      init: function () {
          this.el.addEventListener('click',function(e) {
              const content = document.getElementById('status-textarea').components.textarea.textarea.value
              axios.post('status', {
                content: content
              })
              document.getElementById('status-textarea').components.textarea.textarea.value = ''
              refreshStatus()
          });
      }
    });
  </script>
  <a-scene id="page" physics="debug: true">
    <a-assets>
      <a-asset-item id="tongsampah" src="../assets/scene.gltf"></a-asset-item>
    </a-assets>

    <a-camera id="camera">
      <a-entity 
        raycaster = "objects: #kotak, .clickable;"
        cursor = "rayOrigin: mouse"
        >
        </a-entity>
      </a-entity>
    </a-camera>
    
    <a-entity id="wall_content" >
    <!-- better implementation -->
    <!-- <a-entity position="0 2 -1">
      <a-box class="clickable" add-user-button width="1" height="0.2" depth="0.2"></a-box>
      <a-text text="value: User; align:center " position="0 0 0.1" color="black"></a-text>
    </a-entity> -->
      <% var i = 0; if (statuses) { %>
        <% statuses.forEach (function (status){ i+=1 %> 
          <a-entity kotak-status 
            id_status="<%= status.id %>"
            <% if(status.user.id == user_id) { %>
                class="clickable"
              <% } %>
            sender="<%=status.user.id%>" id="<%=status.id%>-statuscontent" 
            <% if(status.user.id == user_id) { %>
              material = "color:green"
            
            <% }else {%> 
              material = "color:blue"
            <% } %> 
             geometry="primitive: plane;height:0.2; width:2;" position="0 <%=i*0.3 %> -2" color="#4CC3D9" text="color:white; align: center; value:<%=status.user.name%> <%=status.content%>;" ></a-entity>
      <% }) } %>
    </a-entity>
    
    <a-entity class="clickable" id="title" kotak-status text-geometry="value: What's up" position="0 2 -1"></a-entity>
    <a-gui-flex-container 
      flex-direction="column" justify-content="center" align-items="normal" component-padding="0.1" opacity="0.7" width="3.5" height="4.5"
      position="2 2.5 -4" rotation="0 0 0"
    >
    </a-gui-flex-container>

    <a-plane static-body rotation="-90 0 0" height="20" width="20w" position="0 0 -1"></a-plane>
    <a-box kotak-status id="kotak" position="0 1 -1" color="#4CC3D9"></a-box>
    <a-sky color="black"></a-sky>
    
    <a-entity position="2 2 -1.9">
      <a-box class="clickable" send-status-button  color="yellow" position="1 0 -0.7"> </a-box>
      <a-entity id="status-textarea" textarea="backgroundColor: blue; color: white" class="clickable" geometry="primitive:plane;" material="color: blue"></a-entity>
      <a-text class="clickable" text="value: Send" position="0.7 0 -0.2"></a-text>
    </a-entity>
    <a-entity id="tempatsampah" tong-sampah static-body class="clickable" gltf-model="#tongsampah" scale= "0.1 0.1 0.1" position="3 0 -1.5"></a-entity>
  </a-scene>
  <%- include('../layout/footer'); -%>
</html>
<script>
  const user_id = "<%=user_id%>"
  function refreshStatus() {
    axios.get('/get_status')
    .then(object => {
      var text = ''
      var i = 1
      $('#wall_content').empty()
      object.data.forEach (function (status){
        $('#wall_content').append(
          `<a-entity kotak-status ${status.user.id == user_id ? 'class="clickable"': ''}` +
            `sender="${status.user.id}" id_status=${status.id} id="${status.id}-statuscontent"` + 
            `${status.user.id == user_id ? 'material = "color:green"' : 'material = "color:blue"'}` +
            `geometry="primitive: plane;height:0.2; width:2;" position="0 ${i*0.2} -2" text="color:white; align: center; value:${status.user.name} ${status.content};">` +
          `</a-entity>`
          )
        i+=1
      })
    })
  }
  $('#buttons').on('click', function(e){
    e.preventDefault()
    
  });
  $(document).ready(function() {
    console.log('ready')
  });
  document.querySelector('#tempatsampah').addEventListener('collide', function (evt) {
    
  });
  
  document.querySelector('#kotak').addEventListener('click', function (evt) {
    console.log('This 2D element was clicked!');
    console.log(evt.target.getAttribute('position'))
  });

</script>