<script>
  const name = "<%=name%>"
  socket.on('get message', function (data) {
    var pesan = `${data.name}: ${data.msg}`
    const receiver_id = data.receiver_id
    const conversation_id = data.conversation_id
    if(document.getElementById(conversation_id+'-chatpage')) {
      //exist
      const chatText = document.getElementById(conversation_id+'-chattext')
      $(`#${conversation_id}-chattext`).attr('value', $(`#${conversation_id}-chattext`).attr('value') + pesan + '\n' )
    }
    else {
      spawnChat(conversation_id)
    }
  })
  function spawnChat(conversation_id){
    //get penerima disini
    console.log(conversation_id)
    axios.post('/detail_conversation', {
      conversation: conversation_id
    }).then(conversation => {
      var conversation = conversation.data[0]
      var conversation_id = conversation.id
      var id_penerima = conversation.user_1 == user_id ? conversation.user_2 : conversation.user_1
      var camera = document.querySelector('#camera').getAttribute('position')
      const shape = 
      `<a-entity id='${conversation_id}-chatpage' look-at="#camera" geometry="primitive: plane"  material="color: #7BC8A4" position="${camera.x} ${camera.y} ${camera.z-3}"> ` + 
        `<a-plane id="${conversation_id}-chatbox" class="clickable"` + 
        `width="2" height="1" color="#7BC8A4" chat-drag></a-plane>` +
        `<a-entity id="${conversation_id}-input" textarea="backgroundColor: blue; color: white; cols: 20; rows: 4;" class="clickable" geometry="primitive:plane;height:0.3; width:0.9" material="color: blue" position="0 -1 0" rotation="-30 0 0"  undrag-chat></a-entity>` +
        `<a-entity id="${conversation_id}-submit"conversation_id='${conversation_id}' user_penerima='${id_penerima}' class="clickable" geometry="primitive:plane;height:0.3; width:0.9" material="color: green" submit-chat position="1.2 -1 0" rotation="-30 0 0"></a-entity>` +
        `</a-entity>`
      $('#pages').append(shape)
      axios.post('/get_chat', {
        conversation: conversation_id
      }).then(result => {
        var pesan = ''
        result.data.forEach(element => {
          pesan += `${element.user.name}: ${element.content}\n`
        })
        const chatText = 
        `<a-text id='${conversation_id}-chattext' value ='${pesan}' align="center" position ='0 0 0.2' color="white" > </a-text> `
        $(`#${conversation_id}-chatpage`).append(chatText)
      }).catch(error => {
        console.log(error)
      })
    })
  }
 </script>