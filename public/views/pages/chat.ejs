<a-text value = "bottom text" color="white" position="-3 0 -3"></a-text>

<script>
  const name = "<%=name%>"
  console.log(user_id)  
  $('#buttons').on('click', function(e){
    e.preventDefault()
  });
  socket.on('get message', function (data) {
    var pesan = `${data.name}: ${data.msg}`
    const receiver_id = data.receiver_id
    const conversation_id = data.conversation_id
    if(document.getElementById(conversation_id+'-chatpage')) {
      //exist
      const chatText = document.getElementById(conversation_id+'-chattext')
      $(`#${conversation_id}-chattext`).attr('value', $(`#${conversation_id}-chattext`).attr('value') + pesan + '\n' )
    }
    else {
      spawnChat(conversation_id)
    }
  })
  function spawnChat(conversation_id){
    //get penerima disini
    console.log(conversation_id)
    axios.post('/detail_conversation', {
      conversation: conversation_id
    }).then(conversation => {
      var conversation = conversation.data[0]
      var conversation_id = conversation.id
      var id_penerima = conversation.user_1 == user_id ? conversation.user_2 : conversation.user_1
      var camera = document.querySelector('#camera').getAttribute('position')
      const shape = 
      `<a-entity id='${conversation_id}-chatpage' kotak-chat geometry="primitive: plane" class="clickable" material="color: #7BC8A4" position="${camera.x} ${camera.y} ${camera.z-3}"> ` + 
        `<a-plane id="${conversation_id}-chatbox"` + 
        `width="3" height="2" color="#7BC8A4" ></a-plane>` +
        `<a-entity id="${conversation_id}-input" textarea="backgroundColor: blue; color: white" class="clickable" geometry="primitive:plane;" material="color: blue" position="0 -1.7 0" rotation="-30 0 0"></a-entity>` +
        `<a-entity id="${conversation_id}-submit" conversation_id='${conversation_id}' user_penerima='${id_penerima}' class="clickable" geometry="primitive:plane;" material="color: green" submit-chat position="1.2 -1.7 0" rotation="-30 0 0"></a-entity >` +
        `</a-entity>`
      $('#pages').append(shape)
      axios.post('/get_chat', {
        conversation: conversation_id
      }).then(result => {
        var pesan = ''
        result.data.forEach(element => {
          pesan += `${element.user.name}: ${element.content}\n`
        })
        const chatText = 
        `<a-text id='${conversation_id}-chattext' value ='${pesan}' align="center" position ='0 0 0.1' color="white" > </a-text> `
        $(`#${conversation_id}-chatpage`).append(chatText)
      }).catch(error => {
        console.log(error)
      })
    })
  }
  
  function refreshSearch(result) {
      var text = ''
      var i = 1
      $('#conversation_wall').empty()
      if(result.length>0){
        result.forEach (function (result){
          if(result.id != user_id)
          $('#conversation_wall').append(
            `<a-entity position="0 ${i*0.3} -1">`+
              `<a-box id="${result.id}-result" user_id="${result.id}" class="clickable" add-user-button width="1" height="0.2" depth="0.2"></a-box>` +
              ` <a-text text="value: ${result.name}; align:center " position="0 0 0.1" color="black"></a-text>` +
            `</a-entity>`
            )
          i+=1
        })
      }
      else {
        $('#conversation_wall').append('<a-text text="value: Not Found!" ></a-text>')
      }
  }
  
 </script>